---
- name: Validation du cluster Patroni
  hosts: all
  become: yes
  tasks:
    - name: Vérifier la présence des certificats
      stat:
        path: "{{ item }}"
      register: cert_stat
      loop:
        - /certs/ca.crt
        - /certs/server.crt
        - /certs/server.key
      failed_when: not item.stat.exists

- name: Vérifier ETCD (Quorum et Santé)
  hosts: etcd1
  tasks:
    - name: Vérifier la santé du cluster ETCD
      command: >
        etcdctl --endpoints=https://etcd1:2379,https://etcd2:2379,https://etcd3:2379 
        --cacert=/certs/ca.crt --cert=/certs/etcd-server.crt --key=/certs/etcd-server.key endpoint health
      register: etcd_health
      failed_when: "'is healthy' not in etcd_health.stdout"

- name: Vérifier Patroni et PostgreSQL
  hosts: pg_cluster
  tasks:
    - name: Vérifier l'API Patroni (200 OK)
      uri:
        url: "https://{{ inventory_hostname }}:8008/health"
        user: "{{ patroni_api_user }}"
        password: "{{ patroni_api_password }}"
        validate_certs: no
        force_basic_auth: yes
      register: patroni_health

    - name: Vérifier le statut de réplication
      command: psql -t -c "SELECT pg_is_in_recovery();"
      become_user: postgres
      register: pg_recovery

- name: Vérifier la route via HAProxy (Lecture/Écriture)
  hosts: haproxy
  tasks:
    - name: Tester le port RW (5000)
      wait_for:
        port: 5000
        timeout: 5

    - name: Tester le port RO (5001)
      wait_for:
        port: 5001
        timeout: 5

- name: Vérifier PgBouncer et exécution SQL
  hosts: pgbouncer
  tasks:
    - name: Tester le port PgBouncer (6432)
      wait_for:
        port: 6432
        timeout: 5

    - name: Exécuter une requête SQL via PgBouncer
      command: psql -h localhost -p 6432 -U postgres -d postgres -c "SELECT 1;"
      environment:
        PGPASSWORD: "{{ postgres_password }}"
      register: pgbouncer_sql
      failed_when: "'1' not in pgbouncer_sql.stdout"

- name: Test de Failover (Simulation)
  hosts: pg_cluster
  serial: 1
  tasks:
    - name: Identifier le Leader actuel
      uri:
        url: "https://{{ inventory_hostname }}:8008/leader"
        user: "{{ patroni_api_user }}"
        password: "{{ patroni_api_password }}"
        validate_certs: no
        force_basic_auth: yes
      register: is_leader
      ignore_errors: yes

    - name: Simuler une panne si c'est le leader
      shell: "pkill -f patroni"
      when: is_leader.status == 200
      register: failover_simulated

    - name: Attendre l'élection d'un nouveau leader
      pause:
        seconds: 15
      when: is_leader.status == 200

    - name: Vérifier qu'un leader est de nouveau disponible
      uri:
        url: "https://{{ inventory_hostname }}:8008/leader"
        user: "{{ patroni_api_user }}"
        password: "{{ patroni_api_password }}"
        validate_certs: no
        force_basic_auth: yes
      register: leader_check
      until: leader_check.status == 200 or leader_check.status == 503
      retries: 5
      delay: 5
